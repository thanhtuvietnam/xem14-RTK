var j=o=>{throw TypeError(o)};var _=(o,t,e)=>t.has(o)||j("Cannot "+e);var i=(o,t,e)=>(_(o,t,"read from private field"),e?e.call(o):t.get(o)),f=(o,t,e)=>t.has(o)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(o):t.set(o,e),p=(o,t,e,s)=>(_(o,t,"write to private field"),s?s.call(o,e):t.set(o,e),e),a=(o,t,e)=>(_(o,t,"access private method"),e);import{V as rt,i as ot,b as D,p as ht,c as H,Q as k,l as q,e as at,D as I,R as dt,T as ut,d as M,L as $,I as ct,f as F,g as lt,h as pt,j as ft,k as vt}from"./index-xleVCo4H.js";const yt=o=>vt(o);var T,h,n,m,w,r,E,P,U,Q,K,B,W,J,X,Y,z,G,Z,tt;class gt{constructor(t,e){f(this,r);f(this,T);f(this,h);f(this,n);f(this,m);f(this,w);p(this,n,null),p(this,m,null),this.config={},p(this,w,new Set),p(this,T,t),p(this,h,e)}get instance(){return i(this,n)}setup(t){const{streamType:e}=i(this,h).$state,s=H(e).includes("live"),c=H(e).includes("ll-");p(this,n,new t({lowLatencyMode:c,backBufferLength:c?4:s?8:void 0,renderTextTracksNatively:!1,...this.config}));const u=a(this,r,Q).bind(this);for(const l of Object.values(t.Events))i(this,n).on(l,u);i(this,n).on(t.Events.ERROR,a(this,r,Y).bind(this));for(const l of i(this,w))l(i(this,n));i(this,h).player.dispatch("hls-instance",{detail:i(this,n)}),i(this,n).attachMedia(i(this,T)),i(this,n).on(t.Events.AUDIO_TRACK_SWITCHED,a(this,r,W).bind(this)),i(this,n).on(t.Events.LEVEL_SWITCHED,a(this,r,J).bind(this)),i(this,n).on(t.Events.LEVEL_LOADED,a(this,r,X).bind(this)),i(this,n).on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,a(this,r,K).bind(this)),i(this,n).on(t.Events.CUES_PARSED,a(this,r,B).bind(this)),i(this,h).qualities[k.enableAuto]=a(this,r,G).bind(this),q(i(this,h).qualities,"change",a(this,r,Z).bind(this)),q(i(this,h).audioTracks,"change",a(this,r,tt).bind(this)),p(this,m,at(a(this,r,P).bind(this)))}onInstance(t){return i(this,w).add(t),()=>i(this,w).delete(t)}loadSource(t){var e;D(t.src)&&((e=i(this,n))==null||e.loadSource(t.src))}destroy(){var t,e;(t=i(this,n))==null||t.destroy(),p(this,n,null),(e=i(this,m))==null||e.call(this),p(this,m,null)}}T=new WeakMap,h=new WeakMap,n=new WeakMap,m=new WeakMap,w=new WeakMap,r=new WeakSet,E=function(t,e){return new I(yt(t),{detail:e})},P=function(){if(!i(this,h).$state.live())return;const t=new dt(a(this,r,U).bind(this));return t.start(),t.stop.bind(t)},U=function(){var t;i(this,h).$state.liveSyncPosition.set(((t=i(this,n))==null?void 0:t.liveSyncPosition)??1/0)},Q=function(t,e){var s;(s=i(this,h).player)==null||s.dispatch(a(this,r,E).call(this,t,e))},K=function(t,e){const s=a(this,r,E).call(this,t,e);let c=-1;for(let u=0;u<e.tracks.length;u++){const l=e.tracks[u],d=l.subtitleTrack??l.closedCaptions,C=new ut({id:`hls-${l.kind}-${u}`,src:d==null?void 0:d.url,label:l.label,language:d==null?void 0:d.lang,kind:l.kind,default:l.default});C[M.readyState]=2,C[M.onModeChange]=()=>{C.mode==="showing"?(i(this,n).subtitleTrack=u,c=u):c===u&&(i(this,n).subtitleTrack=-1,c=-1)},i(this,h).textTracks.add(C,s)}},B=function(t,e){var l;const s=(l=i(this,n))==null?void 0:l.subtitleTrack,c=i(this,h).textTracks.getById(`hls-${e.type}-${s}`);if(!c)return;const u=a(this,r,E).call(this,t,e);for(const d of e.cues)d.positionAlign="auto",c.addCue(d,u)},W=function(t,e){const s=i(this,h).audioTracks[e.id];if(s){const c=a(this,r,E).call(this,t,e);i(this,h).audioTracks[$.select](s,!0,c)}},J=function(t,e){const s=i(this,h).qualities[e.level];if(s){const c=a(this,r,E).call(this,t,e);i(this,h).qualities[$.select](s,!0,c)}},X=function(t,e){var N;if(i(this,h).$state.canPlay())return;const{type:s,live:c,totalduration:u,targetduration:l}=e.details,d=a(this,r,E).call(this,t,e);i(this,h).notify("stream-type-change",c?s==="EVENT"&&Number.isFinite(u)&&l>=10?"live:dvr":"live":"on-demand",d),i(this,h).notify("duration-change",u,d);const C=i(this,n).media;i(this,n).currentLevel===-1&&i(this,h).qualities[k.setAuto](!0,d);for(const y of i(this,n).audioTracks){const R={id:y.id.toString(),label:y.name,language:y.lang||"",kind:"main"};i(this,h).audioTracks[$.add](R,d)}for(const y of i(this,n).levels){const R={id:((N=y.id)==null?void 0:N.toString())??y.height+"p",width:y.width,height:y.height,codec:y.codecSet,bitrate:y.bitrate};i(this,h).qualities[$.add](R,d)}C.dispatchEvent(new I("canplay",{trigger:d}))},Y=function(t,e){var s;if(e.fatal)switch(e.type){case"mediaError":(s=i(this,n))==null||s.recoverMediaError();break;default:a(this,r,z).call(this,e.error);break}},z=function(t){i(this,h).notify("error",{message:t.message,code:1,error:t})},G=function(){i(this,n)&&(i(this,n).currentLevel=-1)},Z=function(){const{qualities:t}=i(this,h);!i(this,n)||t.auto||(i(this,n)[t.switch+"Level"]=t.selectedIndex,ct&&(i(this,T).currentTime=i(this,T).currentTime))},tt=function(){const{audioTracks:t}=i(this,h);i(this,n)&&i(this,n).audioTrack!==t.selectedIndex&&(i(this,n).audioTrack=t.selectedIndex)};var x,g,A,S,it,et,st,nt;class St{constructor(t,e,s){f(this,S);f(this,x);f(this,g);f(this,A);p(this,x,t),p(this,g,e),p(this,A,s),a(this,S,it).call(this)}}x=new WeakMap,g=new WeakMap,A=new WeakMap,S=new WeakSet,it=async function(){const t={onLoadStart:a(this,S,et).bind(this),onLoaded:a(this,S,st).bind(this),onLoadError:a(this,S,nt).bind(this)};let e=await Et(i(this,x),t);if(F(e)&&!D(i(this,x))&&(e=await Lt(i(this,x),t)),!e)return null;if(!e.isSupported()){const s="[vidstack] `hls.js` is not supported in this environment";return i(this,g).player.dispatch(new I("hls-unsupported")),i(this,g).notify("error",{message:s,code:4}),null}return e},et=function(){i(this,g).player.dispatch(new I("hls-lib-load-start"))},st=function(t){i(this,g).player.dispatch(new I("hls-lib-loaded",{detail:t})),i(this,A).call(this,t)},nt=function(t){const e=lt(t);i(this,g).player.dispatch(new I("hls-lib-load-error",{detail:e})),i(this,g).notify("error",{message:e.message,code:4,error:e})};async function Lt(o,t={}){var e,s,c,u,l;if(!F(o)){if((e=t.onLoadStart)==null||e.call(t),o.prototype&&o.prototype!==Function)return(s=t.onLoaded)==null||s.call(t,o),o;try{const d=(c=await o())==null?void 0:c.default;if(d&&d.isSupported)(u=t.onLoaded)==null||u.call(t,d);else throw Error("");return d}catch(d){(l=t.onLoadError)==null||l.call(t,d)}}}async function Et(o,t={}){var e,s,c;if(D(o)){(e=t.onLoadStart)==null||e.call(t);try{if(await pt(o),!ft(window.Hls))throw Error("");const u=window.Hls;return(s=t.onLoaded)==null||s.call(t,u),u}catch(u){(c=t.onLoadError)==null||c.call(t,u)}}}const Tt="https://cdn.jsdelivr.net";var b,v,L;const O=class O extends rt{constructor(){super(...arguments);f(this,b);f(this,v);f(this,L);this.$$PROVIDER_TYPE="HLS",p(this,b,null),p(this,v,new gt(this.video,this.ctx)),p(this,L,`${Tt}/npm/hls.js@^1.5.0/dist/hls.min.js`)}get ctor(){return i(this,b)}get instance(){return i(this,v).instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return i(this,v).config}set config(e){i(this,v).config=e}get library(){return i(this,L)}set library(e){p(this,L,e)}preconnect(){D(i(this,L))&&ht(i(this,L))}setup(){super.setup(),new St(i(this,L),this.ctx,e=>{p(this,b,e),i(this,v).setup(e),this.ctx.notify("provider-setup",this);const s=H(this.ctx.$state.source);s&&this.loadSource(s)})}async loadSource(e,s){if(!D(e.src)){this.removeSource();return}this.media.preload=s||"",this.appendSource(e,"application/x-mpegurl"),i(this,v).loadSource(e),this.currentSrc=e}onInstance(e){const s=i(this,v).instance;return s&&e(s),i(this,v).onInstance(e)}destroy(){i(this,v).destroy()}};b=new WeakMap,v=new WeakMap,L=new WeakMap,O.supported=ot();let V=O;export{V as HLSProvider};
